<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:c="http://www.springframework.org/schema/c"
	xmlns:p="http://www.springframework.org/schema/p" xmlns:jee="http://www.springframework.org/schema/jee"
	xmlns:si="http://www.springframework.org/schema/integration" xmlns:jms="http://www.springframework.org/schema/integration/jms"
	xsi:schemaLocation="http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd
	http://www.springframework.org/schema/jee http://www.springframework.org/schema/jee/spring-jee.xsd
	http://www.springframework.org/schema/integration http://www.springframework.org/schema/integration/spring-integration-4.1.xsd
	http://www.springframework.org/schema/integration/jms http://www.springframework.org/schema/integration/jms/spring-integration-jms-4.1.xsd">
	<bean id="xmlMessageConverter" class="org.cucina.engine.server.jms.XmlEncoderDecoderConverter" />
	<si:channel id="workflowRequest" />
	<si:channel id="unroutableRequestChannel" />
	<si:logging-channel-adapter channel="unroutableRequestChannel"
		level="ERROR" logger-name="Unroutable.Request" />
	<si:payload-type-router input-channel="workflowRequest"
		default-output-channel="unroutableRequestChannel">
		<si:mapping type="org.cucina.engine.server.event.workflow.WorkflowEvent"
			channel="orchestrateChannel" />
		<si:mapping type="org.cucina.engine.server.event.EngineEvent"
			channel="outputChannel" />
	</si:payload-type-router>
	<si:channel id="outputChannel" />
	<si:channel id="orchestrateChannel" />
	<bean id="orchestratorHandler" class="org.cucina.engine.client.service.OrchestratorHandler"
		c:replyChannel-ref="workflowReply" c:operativeFactory-ref="operativeFactory" />
	<si:service-activator input-channel="orchestrateChannel"
		ref="orchestratorHandler">
	</si:service-activator>
	<bean id="operativeFactory" class="org.cucina.engine.client.service.OperativeFactoryImpl" />
	<bean id="operative" scope="prototype"
		class="org.cucina.engine.client.service.OperativeImpl"
		c:requestChannel-ref="outputPollableChannel"
		c:callbackReplyChannel-ref="callbackReply" c:eventHandler-ref="eventHandler" />
	<si:channel id="outputPollableChannel">
		<si:queue />
	</si:channel>
	<si:bridge input-channel="outputPollableChannel"
		output-channel="outputChannel">
		<si:poller fixed-rate="1" />
	</si:bridge>
	<si:channel id="workflowReply" />
	<si:channel id="callbackReply" />
	<si:channel id="outputAsync" />
	<jms:outbound-gateway request-channel="outputChannel"
		reply-channel="outputReplyChannel" message-converter="xmlMessageConverter"
		request-destination-name="souffle.server.queue" connection-factory="jmsConnectionFactory"
		destination-resolver="myDestinationResolver" />
	<jms:outbound-channel-adapter channel="outputAsync"
		destination-name="souffle.server.queue" message-converter="xmlMessageConverter"
		connection-factory="jmsConnectionFactory" destination-resolver="myDestinationResolver" />
	<jms:inbound-gateway request-channel="outputReplyChannel"
		reply-channel="callbackReply" request-destination-name="engine.client.queue"
		message-converter="xmlMessageConverter" connection-factory="jmsConnectionFactory"
		destination-resolver="myDestinationResolver" />
	<si:channel id="outputReplyChannel" />
	<si:channel id="unroutableReplyChannel" />
	<si:logging-channel-adapter channel="unroutableReplyChannel"
		level="ERROR" logger-name="Unroutable.Reply" log-full-message="true" />
	<si:payload-type-router input-channel="outputReplyChannel"
		default-output-channel="unroutableReplyChannel">
		<si:mapping type="org.cucina.engine.server.event.workflow.ValueEvent"
			channel="workflowReplyChannel" />
		<si:mapping type="org.cucina.engine.server.event.CallbackEvent"
			channel="conversationReplyChannel" />
		<si:mapping type="org.cucina.engine.server.event.CommitEvent"
			channel="conversationReplyChannel" />
		<si:mapping type="org.cucina.engine.server.event.RollbackEvent"
			channel="conversationReplyChannel" />
	</si:payload-type-router>
	<si:channel id="unroutableConversationChannel" />
	<si:logging-channel-adapter channel="unroutableConversationChannel"
		level="ERROR" logger-name="Unroutable.Conversation" log-full-message="true" />
	<si:router input-channel="conversationReplyChannel"
		expression="@operativeFactory.findChannel(headers.get('conversationId'))"
		default-output-channel="unroutableConversationChannel" />

	<si:channel id="conversationReplyChannel" />
</beans>
